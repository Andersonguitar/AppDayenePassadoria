<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√≠nea Passadoria - Sistema de Controlo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; font-weight: 700; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: none; align-items: center; justify-content: center; z-index: 100; flex-direction: column; }
        .card { background: white; border-radius: 1.25rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .btn-primary { background-color: #4f46e5; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #4338ca; transform: translateY(-1px); }
        input, select { height: 2.75rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0 1rem; outline: none; transition: border-color 0.2s; }
        input:focus, select:focus { border-color: #4f46e5; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); display: none; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(4px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="antialiased">
    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-600"></div>
        <p class="mt-4 text-indigo-900 font-semibold" id="loader-text">A processar...</p>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="card w-full max-w-md mx-4 overflow-hidden">
            <div class="p-6">
                <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-2xl mb-4">‚ùì</div>
                <h3 class="text-xl font-bold text-slate-900" id="modal-title">Confirmar A√ß√£o</h3>
                <p class="mt-2 text-slate-600 leading-relaxed" id="modal-msg"></p>
            </div>
            <div class="bg-slate-50 p-4 flex gap-3 justify-end">
                <button id="modal-cancel" class="px-4 py-2 text-slate-600 font-semibold hover:bg-slate-200 rounded-xl transition-colors">Cancelar</button>
                <button id="modal-confirm" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Pedido -->
    <div id="edit-order-modal" class="modal-overlay">
        <div class="card w-full max-w-md mx-4 overflow-hidden">
            <div class="p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-4">Editar Pedido</h3>
                <input type="hidden" id="edit-order-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tempo (HH:MM)</label>
                        <input type="text" id="edit-order-hours" class="w-full font-bold" placeholder="01:30">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cabides</label>
                        <input type="number" id="edit-order-cabides" class="w-full">
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 p-4 flex gap-3 justify-end">
                <button onclick="closeEditModal()" class="px-4 py-2 text-slate-600 font-semibold hover:bg-slate-200 rounded-xl">Cancelar</button>
                <button onclick="saveEditOrder()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-100 hover:bg-indigo-700">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Cliente -->
    <div id="edit-client-modal" class="modal-overlay">
        <div class="card w-full max-w-md mx-4 overflow-hidden">
            <div class="p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-4">Editar Cliente</h3>
                <input type="hidden" id="edit-cli-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nome Completo</label>
                        <input type="text" id="edit-cli-nome" class="w-full">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Telefone / WhatsApp</label>
                        <input type="text" id="edit-cli-contato" class="w-full">
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 p-4 flex gap-3 justify-end">
                <button onclick="closeEditClientModal()" class="px-4 py-2 text-slate-600 font-semibold hover:bg-slate-200 rounded-xl">Cancelar</button>
                <button onclick="saveEditClient()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-100 hover:bg-indigo-700">Atualizar Cadastro</button>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">L√≠nea Passadoria</h1>
                <p class="text-slate-500 font-medium">Gest√£o de Produ√ß√£o e Saldos</p>
                <div id="status-conexao" class="text-[10px] mt-1 font-bold uppercase tracking-widest text-amber-500 italic">A verificar liga√ß√£o...</div>
            </div>
            <button onclick="loadAllData()" class="hidden items-center justify-center gap-2 bg-white border border-slate-200 text-slate-600 px-5 py-2.5 rounded-xl hover:bg-slate-50 transition-all font-semibold shadow-sm">
                <span>üîÑ</span> Sincronizar Drive
            </button>
        </header>

        <nav class="flex overflow-x-auto space-x-2 mb-8 border-b border-slate-200 no-scrollbar">
            <button onclick="switchTab('pedidos')" id="tab-pedidos" class="whitespace-nowrap pb-3 px-4 text-sm font-medium tab-active">Novo Pedido</button>
            <button onclick="switchTab('clientes')" id="tab-clientes" class="whitespace-nowrap pb-3 px-4 text-sm font-medium text-slate-500 hover:text-indigo-600">Clientes</button>
            <button onclick="switchTab('pecas')" id="tab-pecas" class="whitespace-nowrap pb-3 px-4 text-sm font-medium text-slate-500 hover:text-indigo-600">Pe√ßas</button>
            <button onclick="switchTab('status')" id="tab-status" class="whitespace-nowrap pb-3 px-4 text-sm font-medium text-slate-500 hover:text-indigo-600">Hist√≥rico</button>
        </nav>

        <main>
            <section id="sec-pedidos" class="space-y-6">
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <span class="bg-indigo-50 p-2 rounded-lg text-indigo-600">üìù</span> Criar Pedido
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="space-y-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase">Cliente</label>
                            <select id="order-client" class="w-full" onchange="updateClientInfo()"></select>
                        </div>
                        <div id="client-info-box" class="flex flex-col justify-center px-5 py-3 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                            <span class="text-xs text-slate-400 italic text-center">Selecione um cliente</span>
                        </div>
                    </div>
                    <div class="space-y-3 mb-8">
                        <label class="block text-xs font-bold text-slate-500 uppercase">Itens da Entrega</label>
                        <div class="flex flex-col md:flex-row gap-2">
                            <select id="order-item-select" class="flex-1"></select>
                            <button onclick="addItemToOrder()" class="btn-primary px-6 py-2 rounded-xl font-bold shadow-sm">Adicionar</button>
                        </div>
                    </div>
                    <div id="order-items-list" class="space-y-2 min-h-[120px] border border-slate-100 rounded-2xl p-4 bg-slate-50/30 mb-8">
                        <p class="text-center text-slate-400 py-8 text-sm">Nenhum item adicionado.</p>
                    </div>
                    <div class="flex flex-col md:flex-row justify-between items-end gap-6 pt-6 border-t border-slate-100">
                        <div class="flex-1 space-y-2 w-full md:w-auto">
                            <label class="block text-xs font-bold text-slate-500 uppercase">Cabides Entregues</label>
                            <input type="number" id="order-cabides" placeholder="Qtd de cabides" class="w-full bg-slate-50 border-slate-200 focus:border-indigo-500">
                        </div>
                        <div class="flex-[1.5] space-y-2 w-full md:w-auto">
                            <div class="flex justify-between items-center">
                                <label class="block text-xs font-bold text-slate-500 uppercase">Tempo (HH:MM)</label>
                                <span id="display-value-real" class="text-xs font-black text-emerald-600 uppercase">R$ 0,00</span>
                            </div>
                            <input type="text" id="order-total-manual" oninput="calculateRealValue()" placeholder="Ex: 01:30" class="w-full text-2xl font-black bg-indigo-50 border-indigo-100 text-indigo-900 focus:border-indigo-500">
                        </div>
                        <button onclick="finalizeOrder()" class="w-full md:w-auto bg-emerald-600 text-white px-12 py-4 rounded-2xl font-black text-lg hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-100">
                            FINALIZAR E SALVAR
                        </button>
                    </div>
                </div>
            </section>

            <section id="sec-clientes" class="hidden space-y-6">
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-6">Registo de Novo Cliente</h2>
                    <form id="form-cliente" onsubmit="handleFormCliente(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="cli-nome" placeholder="Nome do Cliente" required>
                        <input type="text" id="cli-contato" placeholder="Telem√≥vel / WhatsApp" required>
                        <select id="cli-tipo" class="font-semibold">
                            <option value="avulso">Regime: Avulso</option>
                            <option value="pacote">Regime: Pacote (10h)</option>
                        </select>
                        <button type="submit" class="md:col-span-1 btn-primary py-3 rounded-xl font-bold">Gravar Cliente</button>
                    </form>
                </div>
                <div class="card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th class="p-4 font-bold text-slate-600">Nome / Contato</th>
                                    <th class="p-4 font-bold text-slate-600">Regime</th>
                                    <th class="p-4 font-bold text-slate-600 text-center">Saldo</th>
                                    <th class="p-4 font-bold text-slate-600 text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="table-clientes-body" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-pecas" class="hidden space-y-6">
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-6">Novo Item no Cat√°logo</h2>
                    <form id="form-peca" onsubmit="handleFormPeca(event)" class="flex flex-col md:flex-row gap-3">
                        <input type="text" id="peca-nome" placeholder="Nome da Pe√ßa" class="flex-1" required>
                        <button type="submit" class="btn-primary px-8 rounded-xl font-bold">Adicionar</button>
                    </form>
                </div>
                <div id="pecas-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </section>

            <section id="sec-status" class="hidden space-y-4">
                <!-- Filtro de Hist√≥rico -->
                <div class="card p-4">
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="relative flex-1">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">üîç</span>
                            <input type="text" id="filter-history" oninput="renderAll()" placeholder="Filtrar por nome do cliente..." class="w-full pl-10 bg-slate-50 border-slate-200">
                        </div>
                        <select id="filter-status" onchange="renderAll()" class="bg-white border-slate-200 font-bold text-slate-700 min-w-[150px]">
                            <option value="todos">Status: Todos</option>
                            <option value="aberto">Status: Abertos</option>
                            <option value="fechado">Status: Fechados</option>
                        </select>
                    </div>
                </div>
                <div id="history-container" class="space-y-4"></div>
            </section>
        </main>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwtCDkM9WxC0brWNttikH3yKiHMz_qY5JSu02eyp18SQB2KXLFdX_8kGEOeyCcRGwVk/exec";
        const isGoogleEnv = (typeof google !== 'undefined' && google.script && google.script.run);
        
        let db = { clientes: [], pecas: [], pedidos: [] };
        let currentOrderItems = [];

        function timeToDecimal(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const parts = timeStr.split(':');
            const hours = parseInt(parts[0] || 0);
            const minutes = parseInt(parts[1] || 0);
            return hours + (minutes / 60);
        }

        function decimalToTime(decimal) {
            const h = Math.floor(decimal + 0.00001); 
            const m = Math.round((decimal - h) * 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        function calculatePrice(decimalTime, tipoCliente) {
            const ratePerHour = tipoCliente === 'pacote' ? 25 : 30;
            const totalMinutes = Math.round(decimalTime * 60);
            const pricePerMinute = ratePerHour / 60;
            return Math.round((totalMinutes * pricePerMinute) * 100) / 100;
        }

        function calculateRealValue() {
            const clientId = document.getElementById('order-client').value;
            const timeStr = document.getElementById('order-total-manual').value;
            const display = document.getElementById('display-value-real');
            
            if (!clientId || !timeStr.includes(':')) {
                display.innerText = "R$ 0,00";
                return;
            }

            const cli = db.clientes.find(x => String(x.id) === String(clientId));
            const decimal = timeToDecimal(timeStr);
            const price = calculatePrice(decimal, cli.tipo);
            
            display.innerText = `R$ ${price.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function showLoader(show, text = "A processar...") {
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            if(loaderText) loaderText.innerText = text;
            if(loader) loader.style.display = show ? 'flex' : 'none';
        }

        function showConfirm(title, msg, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            modal.style.display = 'flex';
            document.getElementById('modal-confirm').onclick = () => { onConfirm(); modal.style.display = 'none'; };
            document.getElementById('modal-cancel').onclick = () => { modal.style.display = 'none'; };
        }

        async function runCommand(commandName, ...args) {
            if (isGoogleEnv) {
                return new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(res => resolve(res))
                        .withFailureHandler(err => reject(err))[commandName](...args);
                });
            } else {
                const url = `${WEB_APP_URL}?action=${commandName}&data=${encodeURIComponent(JSON.stringify(args))}`;
                try {
                    const response = await fetch(url, { method: 'GET', mode: 'cors', redirect: 'follow' });
                    if (!response.ok) throw new Error("Erro na rede: " + response.statusText);
                    const json = await response.json();
                    if (json.status === 'error') throw new Error(json.message);
                    return json.data;
                } catch (e) {
                    throw new Error("Erro de liga√ß√£o ao Drive.");
                }
            }
        }

        async function loadAllData() {
            showLoader(true, "A sincronizar...");
            try {
                const data = await runCommand('getData');
                if (data) {
                    db = data;
                    renderAll();
                    document.getElementById('status-conexao').innerText = "Online";
                    document.getElementById('status-conexao').className = "text-[10px] mt-1 font-bold uppercase tracking-widest text-emerald-500";
                }
            } catch (e) {
                document.getElementById('status-conexao').innerText = "Offline";
                document.getElementById('status-conexao').className = "text-[10px] mt-1 font-bold uppercase tracking-widest text-red-500";
            } finally {
                showLoader(false);
            }
        }

        function renderAll() {
            // Renderiza√ß√£o de op√ß√µes de clientes
            const clientOptions = '<option value="">Escolha um cliente...</option>' + 
                db.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
            document.getElementById('order-client').innerHTML = clientOptions;
            
            // Renderiza√ß√£o de op√ß√µes de pe√ßas
            document.getElementById('order-item-select').innerHTML = '<option value="">Pe√ßa...</option>' + 
                db.pecas.map(p => `<option value="${p.id}">${p.nome || p.nomedape√ßa}</option>`).join('');

            // Tabela de Clientes
            document.getElementById('table-clientes-body').innerHTML = db.clientes.map(c => `
                <tr class="hover:bg-slate-50">
                    <td class="p-4">
                        <div class="font-bold text-slate-800">${c.nome}</div>
                        <div class="text-[10px] text-slate-400 font-medium tracking-wider">${c.contato || 'N/A'}</div>
                    </td>
                    <td class="p-4 text-xs font-bold uppercase text-indigo-500">${c.tipo}</td>
                    <td class="p-4 text-center font-black">${c.tipo === 'pacote' ? decimalToTime(parseFloat(c.saldohoras) || 0) + 'h' : 'Ôºç'}</td>
                    <td class="p-4 text-right flex justify-end gap-2">
                        <button onclick="openEditClientModal('${c.id}')" class="p-2 hover:bg-slate-100 rounded-lg" title="Editar Cadastro">‚úèÔ∏è</button>
                        ${c.tipo === 'pacote' ? 
                            `<button onclick="confirmRecharge('${c.id}')" class="text-[10px] bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg font-bold border border-emerald-100 hover:bg-emerald-100">Recarregar 10h</button>` : 
                            `<button onclick="confirmUpgrade('${c.id}')" class="text-[10px] bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg font-bold border border-indigo-100 hover:bg-indigo-100">Tornar Pacote</button>`
                        }
                    </td>
                </tr>`).join('');

            // Grid de Pe√ßas
            document.getElementById('pecas-grid').innerHTML = db.pecas.map(p => `<div class="bg-white p-4 rounded-2xl border border-slate-100 text-center shadow-sm"><p class="font-bold text-slate-800 text-sm truncate">${p.nome || p.nomedape√ßa}</p></div>`).join('');
            
            // L√≥gica de Filtro Duplo do Hist√≥rico (Nome + Status)
            const filterName = document.getElementById('filter-history').value.toLowerCase();
            const filterStatus = document.getElementById('filter-status').value;

            const filteredOrders = db.pedidos.filter(p => {
                const matchesName = p.clientenome.toLowerCase().includes(filterName);
                const matchesStatus = filterStatus === 'todos' || p.status === filterStatus;
                return matchesName && matchesStatus;
            });

            // Hist√≥rico (Filtro aplicado aqui)
            document.getElementById('history-container').innerHTML = filteredOrders.slice().reverse().map(p => {
                const cli = db.clientes.find(x => String(x.id) === String(p.clienteid));
                const preco = calculatePrice(parseFloat(p.totalhoras) || 0, cli?.tipo || 'avulso');
                
                return `
                <div class="bg-white p-5 rounded-2xl border-l-4 ${p.status === 'aberto' ? 'border-amber-400' : 'border-emerald-400'} shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-slate-900"><span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded mr-2 text-xs font-bold">üëî ${p.cabides || 0}</span>${p.clientenome}</p>
                            <p class="text-[10px] text-slate-400">${p.data ? new Date(p.data).toLocaleString() : ''}</p>
                        </div>
                        <div class="flex items-center gap-2">
                             <button onclick="toggleStatus('${p.id}', '${p.status}')" class="px-3 py-1.5 rounded-lg text-[10px] font-black uppercase ${p.status === 'aberto' ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">${p.status}</button>
                             <button onclick="openEditModal('${p.id}')" class="p-1.5 hover:bg-slate-100 rounded-lg" title="Editar">‚úèÔ∏è</button>
                             <button onclick="confirmDeleteOrder('${p.id}')" class="p-1.5 hover:bg-red-50 text-red-500 rounded-lg" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between items-end">
                        <p class="text-xl font-black text-indigo-900">${decimalToTime(parseFloat(p.totalhoras) || 0)}h</p>
                        <p class="text-sm font-bold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-lg">R$ ${preco.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                    </div>
                </div>`;
            }).join('');

            if (filteredOrders.length === 0) {
                const msg = filterName !== "" ? `Nenhum pedido encontrado para "${filterName}"` : "Nenhum pedido registado.";
                document.getElementById('history-container').innerHTML = `<p class="text-center text-slate-400 py-8">${msg}</p>`;
            }
        }

        function switchTab(tab) {
            ['pedidos', 'clientes', 'pecas', 'status'].forEach(t => {
                document.getElementById(`sec-${t}`)?.classList.add('hidden');
                document.getElementById(`tab-${t}`)?.classList.remove('tab-active');
            });
            document.getElementById(`sec-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
        }

        function openEditClientModal(id) {
            const c = db.clientes.find(x => String(x.id) === String(id));
            if (!c) return;
            document.getElementById('edit-cli-id').value = id;
            document.getElementById('edit-cli-nome').value = c.nome;
            document.getElementById('edit-cli-contato').value = c.contato || '';
            document.getElementById('edit-client-modal').style.display = 'flex';
        }

        function closeEditClientModal() { document.getElementById('edit-client-modal').style.display = 'none'; }

        async function saveEditClient() {
            const id = document.getElementById('edit-cli-id').value;
            const clienteOriginal = db.clientes.find(x => String(x.id) === String(id));
            const novoNome = document.getElementById('edit-cli-nome').value;
            const novoContato = document.getElementById('edit-cli-contato').value;
            
            if(!novoNome) { alert("Nome √© obrigat√≥rio."); return; }
            
            showLoader(true, "A atualizar dados...");
            try {
                await runCommand('salvarCliente', { ...clienteOriginal, nome: novoNome, contato: novoContato });
                closeEditClientModal();
                await loadAllData();
            } catch (e) { alert(e.message); } finally { showLoader(false); }
        }

        function confirmUpgrade(clienteId) {
            const cliente = db.clientes.find(c => String(c.id) === String(clienteId));
            if(!cliente) return;
            showConfirm("Mudar para Pacote?", `Alterar ${cliente.nome} para regime de Pacote com saldo inicial de 10h?`, async () => {
                showLoader(true, "A atualizar regime...");
                try {
                    const clienteAtualizado = { ...cliente, tipo: 'pacote', saldohoras: 10 };
                    await runCommand('salvarCliente', clienteAtualizado);
                    await loadAllData();
                } catch (e) { alert("Erro: " + e.message); } finally { showLoader(false); }
            });
        }

        function confirmRecharge(clienteId) {
            const cliente = db.clientes.find(c => String(c.id) === String(clienteId));
            if(!cliente) return;
            showConfirm("Recarregar Saldo?", `Adicionar 10h a ${cliente.nome}?`, async () => {
                showLoader(true, "A recarregar...");
                try {
                    const novoSaldo = (parseFloat(cliente.saldohoras) || 0) + 10;
                    const clienteAtualizado = { ...cliente, saldohoras: novoSaldo };
                    await runCommand('salvarCliente', clienteAtualizado);
                    await loadAllData();
                } catch (e) { alert("Erro: " + e.message); } finally { showLoader(false); }
            });
        }

        function confirmDeleteOrder(orderId) {
            const pedido = db.pedidos.find(p => String(p.id) === String(orderId));
            if(!pedido) return;
            showConfirm("Excluir Pedido?", `Tem certeza que deseja excluir permanentemente o pedido de ${pedido.clientenome}?`, async () => {
                showLoader(true, "A excluir pedido...");
                try {
                    await runCommand('excluirPedido', orderId);
                    await loadAllData();
                } catch (e) { alert("Erro: " + e.message); } finally { showLoader(false); }
            });
        }

        function updateClientInfo() {
            const id = document.getElementById('order-client').value;
            const box = document.getElementById('client-info-box');
            calculateRealValue(); 
            if (!id) { box.innerHTML = `<span class="text-xs text-slate-400 italic">Selecionar cliente</span>`; return; }
            const c = db.clientes.find(x => String(x.id) === String(id));
            if (c.tipo === 'pacote') {
                box.innerHTML = `<div class="flex justify-between items-center"><span class="text-[10px] font-black text-slate-400 uppercase">Saldo</span><span class="text-xl font-black ${c.saldohoras >= 0 ? 'text-emerald-600' : 'text-red-600'}">${decimalToTime(parseFloat(c.saldohoras))}h</span></div>`;
            } else { box.innerHTML = `<span class="text-indigo-600 font-bold text-center text-sm">Regime Avulso</span>`; }
        }

        function addItemToOrder() {
            const pecaId = document.getElementById('order-item-select').value;
            if (!pecaId) return;
            const peca = db.pecas.find(p => String(p.id) === String(pecaId));
            const existe = currentOrderItems.find(i => String(i.id) === String(pecaId));
            if (existe) existe.qtd++; else currentOrderItems.push({ id: peca.id, nome: peca.nome || peca.nomedape√ßa, qtd: 1 });
            renderOrderItems();
        }

        function renderOrderItems() {
            const container = document.getElementById('order-items-list');
            if (currentOrderItems.length === 0) { container.innerHTML = `<p class="text-center text-slate-400 py-8 text-sm">Vazio</p>`; return; }
            container.innerHTML = currentOrderItems.map(item => `
                <div class="flex items-center justify-between bg-white p-4 rounded-xl border border-slate-100 mb-2">
                    <p class="font-bold text-slate-800">${item.nome}</p>
                    <div class="flex items-center bg-slate-100 rounded-lg p-1">
                        <button onclick="changeQtd('${item.id}', -1)" class="w-8 h-8 font-bold">Ôºç</button>
                        <span class="px-3 font-bold">${item.qtd}</span>
                        <button onclick="changeQtd('${item.id}', 1)" class="w-8 h-8 font-bold">Ôºã</button>
                    </div>
                </div>`).join('');
        }

        function changeQtd(id, delta) {
            const item = currentOrderItems.find(i => String(i.id) === String(id));
            item.qtd += delta;
            if (item.qtd <= 0) currentOrderItems = currentOrderItems.filter(i => String(i.id) !== String(id));
            renderOrderItems();
        }

        async function finalizeOrder() {
            const clientId = document.getElementById('order-client').value;
            const timeStr = document.getElementById('order-total-manual').value;
            if (!clientId || !timeStr) { alert("Por favor, preencha o cliente e o tempo."); return; }
            const cli = db.clientes.find(x => String(x.id) === String(clientId));
            const pedido = { 
                id: Date.now().toString(), data: new Date().toISOString(), clienteid: cli.id, clientenome: cli.nome, 
                items: JSON.stringify(currentOrderItems), totalhoras: timeToDecimal(timeStr), status: 'aberto', 
                cabides: parseInt(document.getElementById('order-cabides').value || 0)
            };
            showLoader(true, "A salvar pedido...");
            try { 
                await runCommand('registrarPedido', pedido); 
                currentOrderItems = []; 
                document.getElementById('order-total-manual').value = ''; 
                document.getElementById('order-cabides').value = ''; 
                document.getElementById('display-value-real').innerText = "R$ 0,00";
                renderOrderItems(); 
                await loadAllData(); 
                switchTab('status'); 
            } catch(e) { alert("Erro ao salvar: " + e.message); } finally { showLoader(false); }
        }

        async function toggleStatus(id, current) {
            const next = current === 'aberto' ? 'fechado' : 'aberto';
            showLoader(true, "A atualizar...");
            try { await runCommand('atualizarStatusPedido', id, next); await loadAllData(); } catch(e) { alert(e.message); } finally { showLoader(false); }
        }

        async function handleFormCliente(e) {
            e.preventDefault();
            const novo = { 
                id: Date.now().toString(), 
                nome: document.getElementById('cli-nome').value, 
                contato: document.getElementById('cli-contato').value, 
                tipo: document.getElementById('cli-tipo').value, 
                saldohoras: document.getElementById('cli-tipo').value === 'pacote' ? 10 : 0 
            };
            showLoader(true, "A guardar cliente...");
            try { await runCommand('salvarCliente', novo); e.target.reset(); await loadAllData(); } catch(e) { alert(e.message); } finally { showLoader(false); }
        }

        async function handleFormPeca(e) {
            e.preventDefault();
            const nova = { id: Date.now().toString(), nome: document.getElementById('peca-nome').value };
            showLoader(true, "A adicionar pe√ßa...");
            try { await runCommand('salvarPeca', nova); e.target.reset(); await loadAllData(); } catch(e) { alert(e.message); } finally { showLoader(false); }
        }

        function openEditModal(id) {
            const p = db.pedidos.find(x => String(x.id) === String(id));
            if (!p) return;
            document.getElementById('edit-order-id').value = id;
            document.getElementById('edit-order-hours').value = decimalToTime(p.totalhoras);
            document.getElementById('edit-order-cabides').value = p.cabides || 0;
            document.getElementById('edit-order-modal').style.display = 'flex';
        }

        function closeEditModal() { document.getElementById('edit-order-modal').style.display = 'none'; }

        async function saveEditOrder() {
            const id = document.getElementById('edit-order-id').value;
            const pOrig = db.pedidos.find(x => String(x.id) === String(id));
            const nH = timeToDecimal(document.getElementById('edit-order-hours').value);
            const nC = parseInt(document.getElementById('edit-order-cabides').value);
            showLoader(true, "A atualizar...");
            try { 
                await runCommand('registrarPedido', { ...pOrig, totalhoras: nH, cabides: nC }); 
                closeEditModal(); 
                await loadAllData(); 
            } catch(e) { alert(e.message); } finally { showLoader(false); }
        }

        window.onload = loadAllData;
    </script>
</body>
</html>